# 1.步骤流程图

![](../images/动态换肤.jpg)

# 2.手写关键代码分析
1. 为每个Activity的LayoutInflater设置自定义的`LayoutInlater.Factory2`
   1. MyApplication.java
      ```
        @Override
        public void onCreate() {
            super.onCreate();
            SkinManager.init(this);
        }      
      ```
   2. SkinManager.java
      - SkinManager.init(this);
      - instance = new SkinManager(application);
      ```
      private SkinManager(Application application) {
        this.application = application;
        /**
         * 提供了一个应用生命周期回调的注册方法，
         *          * 用来对应用的生命周期进行集中管理，
         *  这个接口叫registerActivityLifecycleCallbacks，可以通过它注册
         *          * 自己的ActivityLifeCycleCallback，每一个Activity的生命周期都会回调到这里的对应方法。
         */
        application.registerActivityLifecycleCallbacks(new SkinActivityLifecycle());
      }
      ```
   3. SkinActivityLifecycle.java
      ```
        @Override
        public void onActivityCreated(Activity activity, Bundle savedInstanceState) {
            LayoutInflater layoutInflater = LayoutInflater.from(activity);
            //添加自定义创建View 工厂
            SkinLayoutFactory factory = new SkinLayoutFactory();
            layoutInflater.setFactory2(factory);
        }
      ```
   4. **SkinLayoutFactory.java：view创建工厂**
      ```
        @Override
        public View onCreateView(View parent, String name, Context context, AttributeSet attrs) {
            // 反射 classLoader
            View view = createViewFromTag(name, context, attrs);
            // 自定义View
            if(null ==  view){
                view = createView(name, context, attrs);
            }
    
            //筛选符合属性View
            skinAttribute.load(view, attrs);
    
            return view;
        }
      ```
   5. **SkinAttribute：筛选View需要换肤的的属性**
      1. skinAttribute.load(view, attrs);
         ```
            public void load(View view, AttributeSet attrs) {
                List<SkinPain> skinPains = new ArrayList<>();
                for (int i = 0; i < attrs.getAttributeCount(); i++) {
                    //获取属性名字
                    String attributeName = attrs.getAttributeName(i);
                    if (mAttributes.contains(attributeName)) {
                        //获取属性对应的值
                        String attributeValue = attrs.getAttributeValue(i);
                        if (attributeValue.startsWith("#")) {
                            continue;
                        }
        
                        int resId;
                        if (attributeValue.startsWith("?")) { // 系统级的?colorPrimary
                            int attrId = Integer.parseInt(attributeValue.substring(1));
                            // 获取真实的id <item name="colorPrimary">@color/colorPrimary</item>                  
                            resId = SkinThemeUtils.getResId(view.getContext(), new int[]{attrId})[0];
                        } else {
                            //@1234564
                            resId = Integer.parseInt(attributeValue.substring(1));
                        }
                        if (resId != 0) {
                            SkinPain skinPain = new SkinPain(attributeName, resId);
                            skinPains.add(skinPain);
                        }
                    }
                }
                if (!skinPains.isEmpty()) {
                    SkinView skinView = new SkinView(view, skinPains);
                    skinView.applySkin();
                    skinViews.add(skinView);
                }
            }         
         ```
         ```
            // <item name="colorPrimary">@color/colorPrimary</item>    
            public static int[] getResId(Context context, int[] attrs){
                int[] ints = new int[attrs.length];
                TypedArray typedArray = context.obtainStyledAttributes(attrs);
                for (int i = 0; i < typedArray.length(); i++) {
                    ints[i] =  typedArray.getResourceId(i, 0);
                }
                typedArray.recycle();
                return ints;
            }         
         ```

